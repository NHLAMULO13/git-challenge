(()=>{"use strict";var e,t=function(e){try{return JSON.parse(e)}catch(e){}return null};let n=()=>{var e,t,n,o;let a=(null===(e=window)||void 0===e||null===(t=e.navigator)||void 0===t||null===(n=t.userAgent)||void 0===n?void 0:n.toLowerCase())||"",{maxTouchPoints:i}=(null===(o=window)||void 0===o?void 0:o.navigator)||{};return a.includes("win")?"Windows":a.includes("android")?"Android":["iphone","ipad"].find(e=>a.includes(e))?"iOS":a.includes("mac")?i&&i>2?"iOS":"macOS":null},o=(e=[])=>{e.forEach(({key:e,value:t})=>{"tags"===e?tp.push(["setTags",t]):tp.push(["setCustomVariable",e,t])})},a="undefined"==typeof Proxy?console:new Proxy({},{get:(e,t)=>(...n)=>{window.IM=window.IM||{},window.IM.logger=window.IM.logger||{queue:[]},e[t]&&e[t](...n),window.IM.logger.queue.push(()=>{let o=window.IM.logger.withName("piano");Object.assign(e,o),o[t](...n)})}}),i=()=>{if(Array.from(document.querySelectorAll("script")).some(e=>"//www.npttech.com/advertising.js"===e.getAttribute("src")))return;a.debug("Inserting Piano adblock script");let{head:e}=document,t=document.createElement("script");t.textContent='\n    document.cookie = "__adblocker=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";\n    var setNptTechAdblockerCookie = function(adblocker) {\n      var d = new Date();\n      d.setTime(d.getTime() + 60 * 5 * 1000);\n      document.cookie = "__adblocker=" + (adblocker ? "true" : "false") + "; expires=" + d.toUTCString() + "; path=/";\n    };\n    var script = document.createElement("script");\n    script.setAttribute("async", true);\n    script.setAttribute("src", "//www.npttech.com/advertising.js");\n    script.setAttribute("onerror", "setNptTechAdblockerCookie(true);");\n    document.getElementsByTagName("head")[0].appendChild(script);\n  ',e.appendChild(t)},r=e=>{window.LUX?Object.entries(e).forEach(([e,t])=>window.LUX.addData(e,t)):a.warn(`Could not add SpeedCurve LUX data as window.LUX is ${window.LUX}`)},d=({optIn:e})=>{r({piano_consent_opt_in:e})},c="/auth/register",s="/api/auth/signup",u=()=>{try{let e=document.getElementById("__AUTH0_SETTINGS__");if(!e)return a.error("Could not find the site context in the DOM on the client side. Returning false."),!1;let t=JSON.parse(e.innerHTML);return t&&0!==Object.keys(t).length?"boolean"!=typeof t.enabled?(a.error('The "enabled" property is missing or not a boolean. Returning false.'),!1):t.enabled:(a.error("The site context JSON on the client side is empty. Returning false."),!1)}catch(e){return a.error("Could not parse the auth0 settings JSON on the client side. Returning false.",e),!1}},l=e=>{tp.push(["setExternalJWT",e]),a.debug("JWT sent to Piano",e)},p=e=>{let t=new URL(e,window.location.origin);t.searchParams.set("redirect",window.location.href),window.location.assign(t.href)},m=(e,t)=>{let n=window.history[e];window.history[e]=(...o)=>{let{pathname:i}=window.location,r=setInterval(()=>{let n=window.location.pathname;i!==n&&(a.debug("Route change detected",{previousPathname:i,newPathname:n,historyFunction:e,callback:t}),t(),clearInterval(r))},500);n.apply(window.history,o)}},w=e=>{var t;(null===(t=performance)||void 0===t?void 0:t.mark)&&performance.mark(e)},h="piano_checkout_params",v={COMPOSER:"IM",ID:"IM",VX:"IM"},f=(Object.keys(v),[...new Set(Object.values(v))]),g=[...f,"AD","AM","DL","PR","CP"],y=[1,2,3,4,5,6,7,8,9,10,11],b=[412],k=e=>(a.debug("loginRequired",{checkoutParams:e}),a.debug("Checkout saving is disabled"),p(u()?s:c),!1),C=(e,t={})=>{window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:e,...t})},I=e=>"object"!=typeof e||null===e?e:Array.isArray(e)?e.map(I).filter(Boolean):Object.entries(e).reduce((e,[t,n])=>null==n?e:"object"==typeof n?Array.isArray(n)?{...e,[t]:n.map(I).filter(Boolean)}:{...e,[t]:I(n)}:{...e,[t]:n},{}),{checkoutClose:S,checkoutComplete:P}={checkoutClose:"abandon_checkout",checkoutComplete:"purchase"},{checkoutClose:x,checkoutComplete:_}={checkoutClose:"checkout_abandoned",checkoutComplete:"checkout_completed"},E=e=>{let{component:t="button",componentVariant:n,termId:o}=(null==e?void 0:e.params)||{},i={piano:{"data-feature":"Piano","data-component":t,"data-component-variant":n,"data-piano-term-id":o}};try{var r;let{experienceId:t,templateId:n,templateVariantId:o,displayMode:a}=JSON.parse((null==e||null===(r=e.params)||void 0===r?void 0:r.templateParams)||"{}");i.piano={...i.piano,"data-piano-experience-id":t,"data-piano-template-id":n,"data-piano-template-variant-id":o,"data-placement-variant":a}}catch(e){a.error("Unable to parse Piano template params object",e)}C("piano-cta-click",I(i));let d=u(),l={"register-button":d?s:c,"sign-in-link":d?"/api/auth/login":"/auth/login"},{eventName:m}=e||{};Object.keys(l).includes(m)&&p(l[m])},A=({termId:e}={})=>{C("begin_checkout",{items:[{item_id:e}]})},O=({chargeAmount:e,chargeCurrency:t,promotionId:n,termId:o,uid:a}={})=>{let i=(()=>{let e=new Date;return`${String(e.getFullYear())}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}${String(e.getHours()).padStart(2,"0")}${String(e.getMinutes()).padStart(2,"0")}`})().concat(null==a?void 0:a.slice(0,10));C(P,I({coupon:n,currency:t,transaction_id:i,value:e,items:[{item_id:o,coupon:n,currency:t,price:e}]})),window.dispatchEvent(new CustomEvent(_,{detail:{termId:o,transactionId:i}}))},T=e=>{var t;if("close"===(null==e?void 0:e.state)&&((null===(t=tp.customVariables)||void 0===t?void 0:t.alreadyHasAccess)||(C(S),window.dispatchEvent(new Event(x)))),["checkoutCompleted","alreadyHasAccess"].includes(null==e?void 0:e.state)){let e=new URLSearchParams(window.location.search).get("clientRedirect");if(!e)return void window.location.reload();window.location.assign(e)}},L=({term:{chargeAmount:e,chargeCurrency:t,originalBillingPlan:n,termId:o}}={term:{}})=>{let a=null==n?void 0:n.chargeAmount,i=a?Number((a-e).toFixed(2)):null;C("add_payment_info",I({currency:t,value:e,items:[{currency:t,discount:i,item_id:o,price:null!=a?a:e}]}))},M=e=>{"alreadyHasAccess"===(null==e?void 0:e.stateName)&&tp.push(["setCustomVariable","alreadyHasAccess",!0])},j=e=>{let{component:t="button",componentVariant:n,termId:o}=(null==e?void 0:e.params)||{},i={piano:{"data-feature":"Piano","data-component":t,"data-component-variant":n,"data-piano-term-id":o}};try{var r;let{experienceId:t,templateId:n,templateVariantId:o,displayMode:a}=JSON.parse((null==e||null===(r=e.params)||void 0===r?void 0:r.templateParams)||"{}");i.piano={...i.piano,"data-piano-experience-id":t,"data-piano-template-id":n,"data-piano-template-variant-id":o,"data-placement-variant":a}}catch(e){a.error("Unable to parse Piano template params object",e)}C("piano-cta-click",I(i))};var H={},N=function(e){window.performance.mark("time-to-getSourcePointCustomVendors-init"),H.sourcePointVendors=e.consentedVendors},U=function(e){window.performance.mark("time-to-setConsentedPurposes-init"),H.consentedPurposes=e.consentedPurposes};"undefined"!=typeof window&&(window.consentCheckerEventData={},function(){if(window.__tcfapi){document.addEventListener("DOMContentLoaded",function(){var e;return e=new CustomEvent("consent-checker.listener-events-before-reload",{detail:{hasKeySignalled:{}}}),void window.dispatchEvent(e)});var e,t=function(t,n){e?n&&"useractioncomplete"===t.eventStatus&&e!==t.tcString&&new Promise(function(e){var t=window.consentCheckerEventData,n=0===Object.keys(t).length,o=Object.values(t).every(function(e){return!0===e});e(!n&&o)}).then(function(e){e&&window.location.reload()}):e=t.tcString},n=function(t,n){n&&"tcloaded"===t.eventStatus&&(e=t.tcString)},o=document.querySelector("[data-cmp='true']");try{o.addEventListener("click",function(){window.__tcfapi("addEventListener",2,t),window.__tcfapi("addEventListener",2,n)})}catch(e){}}}());let B="consentOptIn",R=(e,t)=>{var n,o,i,r;"function"==typeof(null===(n=tp)||void 0===n||null===(o=n.consent)||void 0===o?void 0:o.setByPurpose)?e.forEach(e=>tp.consent.setByPurpose(e,t)):a.error(`Attempted to set Piano consent but tp.consent.setByPurpose was ${null===(i=tp)||void 0===i||null===(r=i.consent)||void 0===r?void 0:r.setByPurpose}.`)},V=e=>{o([{key:B,value:e}])},$=()=>{var e,t,n,o;return o="time-to-checkPurposes-init",window.performance.getEntriesByName(o,"mark").some(function(e){return e.name===o})||window.performance.mark(o),window.__tcfapi("addEventListener",2,function(o,a){var i=o.purpose,r=o.vendor,d=o.eventStatus;return e&&window.__tcfapi("getCustomVendorConsents",2,N),t&&window.__tcfapi("getCustomVendorConsents",2,U),a&&["useractioncomplete","tcloaded"].includes(d)&&(H.siteConsents=i.consents,H.vendorConsents=r.consents,n=[!y||y.every(function(e){return H.siteConsents[e]}),!b||b.every(function(e){return H.vendorConsents[e]}),!e||e.every(function(e){return H.sourcePointVendors.some(function(t){return t._id===e})}),!t||t.every(function(e){var t;return null===(t=H.consentedPurposes)||void 0===t?void 0:t.find(function(t){return t.name===e})})].every(function(e){return e})),n}),!n},D=()=>{w("time-to-piano-initialised"),a.debug("init"),(()=>{var e;if($()&&R(g,"opt-out"),(()=>{var e,t,n,o;if("function"!=typeof(null===(e=tp)||void 0===e||null===(t=e.consent)||void 0===t?void 0:t.getByPurpose))return a.error(`Attempted to get Piano consent but tp.consent.getByPurpose was ${null===(n=tp)||void 0===n||null===(o=n.consent)||void 0===o?void 0:o.getByPurpose}.`),!1;let i=tp.consent.getByPurpose();return!!i&&!Object.entries(i).some(([e,{mode:t}])=>!f.includes(e)&&"opt-in"===t)&&f.every(e=>{var t;return"opt-in"===(null===(t=i[e])||void 0===t?void 0:t.mode)})})())return V(!0),d({optIn:!0}),void i();let t=0;e=()=>{if(t+=1,$())return a.debug("CMP rejected",{eventCount:t}),void(2===t&&(V(!1),d({optIn:!1})));a.debug("CMP accepted",{eventCount:t}),V(!0),R(f,"opt-in"),d({optIn:!0}),i()},window.performance.mark("time-to-waitForConsentChange-init"),window.__tcfapi("addEventListener",2,function(){e(),window.performance.mark("time-to-waitForConsentChange-callback"),window.performance.measure("time-to-waitForConsentChange-init","time-to-waitForConsentChange-callback")})})(),tp.experience.init(),a.debug("Checkout resuming is disabled"),window.localStorage.getItem(h)&&(window.localStorage.removeItem(h),a.debug("Checkout params removed from localStorage"))};window.tp=window.tp||[],w("time-to-piano-loaded"),window.pdl=window.pdl||{},window.pdl.requireConsent="v2",window.pdl.consent={},window.pdl.consent.defaultPurposes=v;let J=()=>{let e=function(e){var n;return document.body&&e?((Array.isArray(e)?e:[e]).some(function(e){return!!(n=function(e){var n=document.body.dataset[e];if(n)return t(n);var o="__".concat(e.trim().replace(/([a-z])([A-Z])/g,"$1_$2").toUpperCase(),"__"),a=document.getElementById(o);return a?t(a.innerHTML):null}(e))}),n):null}("pianoSettings")||{},{enabled:i,applicationId:d,production:c,customVariables:s=[],composerSiteId:p}=e;if(a.debug("Settings parsed",e),!i)return;let h={},v=()=>{Object.keys(h).forEach(e=>{a.debug("checkPianoExperienceReady",{state:h[e]});let{iframeReady:t,experienceId:n}=h[e];if(!t)return;let o=document.querySelector(`iframe[src*="${n}"]`);o?(a.debug(`iframe for ${n} found`,{iframe:o}),w("time-to-piano-experience"),((e,{containerSelector:t,displayMode:n,title:o,experienceId:a,templateId:i,variantId:r})=>{t&&e.setAttribute("data-placement",t),r&&e.setAttribute("data-piano-variant-id",r),e.setAttribute("data-feature","Piano"),e.setAttribute("data-piano-template-id",i),e.setAttribute("data-piano-experience-name",o),e.setAttribute("data-piano-experience-id",a),e.setAttribute("data-placement-variant",n)})(o,h[e]),(({title:e,experienceId:t,templateId:n,variantId:o})=>{r({"piano-active":"Yes","piano-title":e,"piano-experience":t,"piano-template":n,"piano-variant":o})})(h[e])):a.debug(`Can't find the piano iframe for experience ID: ${n}`)})};w("time-to-piano-started"),tp.push(["setDebug","debug"===localStorage.logLevel]),tp.push(["setAid",d]),tp.push(["setSandbox",!c]),tp.push(["setUseTinypassAccounts",!1]),tp.push(["setUsePianoIdUserProvider",!1]),tp.push(["setUsePianoIdLiteUserProvider",!0]),tp.push(["setCxenseSiteId",p]),s.push({key:"operatingSystem",value:n()}),s.push({key:B,value:null}),o(s),(()=>{let{head:e}=document,t=document.createElement("script");t.src="//cdn.tinypass.com/api/tinypass.min.js",t.async=!0,e.appendChild(t)})(),(async()=>{if(!(()=>{let e=document.cookie.split("; ").find(e=>e.startsWith("IMOLOGIN"));return!!e&&"1"===e.split("=")[1]})())return void a.debug("User is not logged in, not fetching token.");let e=u();e||a.debug("Auth0 is not enabled on the client side. Skipping setupAuth.");try{if(e){let e=await async function(){let e=await fetch("/api/auth/v1/get-piano-auth-sync-token",{method:"GET"});if(!e.ok)throw Error(`Error: ${e.status} - ${e.statusText}`);return e.json()}();if(!e||!e.token)return void a.error("No token received from Piano sync token endpoint");l(e.token)}else{let e=await fetch("/auth/user-info?fields=idToken");if(!e.ok)throw Error("Failed to fetch user info");let{idToken:t}=await e.json();if(!t)return void a.error("No idToken found in user info data");l(t)}}catch(e){a.debug("Error during setupAuth:",e)}})().then(()=>{var e;a.debug("adding handlers"),tp.push(["addHandler","loginRequired",k]),tp.push(["addHandler","checkoutClose",T]),tp.push(["addHandler","checkoutComplete",O]),tp.push(["addHandler","checkoutCustomEvent",E]),tp.push(["addHandler","checkoutStateChange",M]),tp.push(["addHandler","startCheckout",A]),tp.push(["addHandler","submitPayment",L]),tp.push(["addHandler","trackBannerClickEvent",j]),tp.push(["init",D]),tp.push(["addHandler","showTemplate",e=>{a.debug("showTemplate",{templateObj:e});let{experienceId:t}=e;h[t]={...h[t],iframeReady:!0},v()}]),tp.push(["addHandler","showOffer",e=>{a.debug("showOffer",{offerObj:e});let{experienceId:t}=e;h[t]={...h[t],iframeReady:!0},v()}]),tp.push(["addHandler","experienceExecute",e=>{a.debug("experienceExecute",{expObj:e});let{events:t,experiences:n}=e.result;t.filter(e=>["showTemplate","showOffer"].includes(e.eventType)).forEach(e=>{let{experienceId:t}=e.eventExecutionContext,{containerSelector:o,displayMode:i,templateId:r,templateVariantId:d}=e.eventParams,c=n.find(e=>e.id===t).title.split(" ").join("-").toLowerCase();a.debug("process experienceExecute",{event:e,experiences:n}),h[t]={...h[t],containerSelector:o,displayMode:i,title:c,experienceId:t,templateId:r,variantId:d}}),v()}]),m("pushState",e=()=>{var e;null===(e=window.tp.experience)||void 0===e||e.execute()}),m("replaceState",e)})};e=()=>{J()},"interactive"===document.readyState||"complete"===document.readyState?e():document.addEventListener("DOMContentLoaded",e)})();